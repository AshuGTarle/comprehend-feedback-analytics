<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Feedback</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ✅ AWS SDK Core -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1480.0.min.js"></script>

  <!-- ✅ Cognito Identity SDK (correct source with global variable exposed) -->
  <script src="https://unpkg.com/amazon-cognito-identity-js@6.2.0/dist/amazon-cognito-identity.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 30px;
    }
    h1 { color: #333; }
    .filters { margin-bottom: 20px; }
    select, button, input {
      margin: 5px 0;
      padding: 7px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    button {
      background: #0073e6;
      border: none;
      color: #fff;
      border-radius: 5px;
    }
    button:hover { background: #005bb5; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
      vertical-align: top;
    }
    th { background: #0073e6; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    .positive { color: green; font-weight: bold; }
    .negative { color: red; font-weight: bold; }
    .neutral  { color: gray; font-weight: bold; }
    .mixed    { color: orange; font-weight: bold; }

    .chart-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }
    .chart-box {
      background: #fff;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    canvas { max-width: 100%; height: 300px !important; }
    .login-box {
      background: #fff;
      padding: 20px;
      max-width: 400px;
      margin: 50px auto;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Feedback Dashboard</h1>

  <!-- Login Form -->
  <div id="loginBox" class="login-box">
    <h2>Login</h2>
    <label>Email:</label><br>
    <input type="text" id="email" placeholder="Enter email"><br><br>
    <label>Password:</label><br>
    <input type="password" id="password" placeholder="Enter password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginMessage" style="color:red;"></p>
  </div>

  <!-- Dashboard Content -->
  <div id="dashboard" class="hidden">

    <!-- Filters and Export -->
    <div class="filters">
      <label for="statusFilter">Status:</label>
      <select id="statusFilter">
        <option value="ALL">All</option>
        <option value="PENDING">Pending</option>
        <option value="PROCESSED">Processed</option>
      </select>

      <label for="sentimentFilter">Sentiment:</label>
      <select id="sentimentFilter">
        <option value="ALL">All</option>
        <option value="POSITIVE">Positive</option>
        <option value="NEGATIVE">Negative</option>
        <option value="NEUTRAL">Neutral</option>
        <option value="MIXED">Mixed</option>
      </select>

      <button onclick="exportCSV()">Export CSV</button>
    </div>

    <!-- Table -->
    <table id="feedbackTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Customer</th>
          <th>Comment</th>
          <th>Status</th>
          <th>Sentiment</th>
          <th>Scores</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Charts -->
    <div class="chart-container">
      <div class="chart-box">
        <h3>Sentiment Distribution</h3>
        <canvas id="sentimentPie"></canvas>
      </div>
      <div class="chart-box">
        <h3>Status Overview</h3>
        <canvas id="statusBar"></canvas>
      </div>
    </div>

    <div class="chart-box" style="margin-top: 20px;">
      <h3>Feedback Over Time</h3>
      <canvas id="feedbackLine"></canvas>
    </div>
  </div>

  <script>
    console.log("AmazonCognitoIdentity available? ", window.AmazonCognitoIdentity);

    const apiUrl = "https://e8oqjp3ji4.execute-api.eu-central-1.amazonaws.com/dev/feedback";
    const poolData = {
      UserPoolId: "eu-central-1_7c9WwAhET",   // ✅ Correct Cognito User Pool ID
      ClientId: "15sdhhkuo9f3upa4919406s5hi"  // ✅ Correct Cognito Client ID
    };

    let globalData = [];
    let idToken = null;

    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      if (!window.AmazonCognitoIdentity) {
        document.getElementById("loginMessage").innerText = "❌ Cognito library not loaded!";
        return;
      }

      const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({
        Username: email,
        Password: password
      });

      const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
      const userData = { Username: email, Pool: userPool };
      const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

      cognitoUser.authenticateUser(authenticationDetails, {
        onSuccess: function(result) {
          idToken = result.getIdToken().getJwtToken();
          document.getElementById("loginBox").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");
          loadFeedback();
        },
        onFailure: function(err) {
          document.getElementById("loginMessage").innerText = err.message || JSON.stringify(err);
        }
      });
    }

    function getSentimentClass(sentiment) {
      switch (sentiment) {
        case "POSITIVE": return "positive";
        case "NEGATIVE": return "negative";
        case "NEUTRAL": return "neutral";
        case "MIXED": return "mixed";
        default: return "";
      }
    }

    async function loadFeedback() {
      const response = await fetch(apiUrl, {
        method: "GET",
        headers: { Authorization: idToken }
      });
      let data = await response.json();
      globalData = data;

      data.sort((a, b) => new Date(b.date) - new Date(a.date));

      const statusFilter = document.getElementById("statusFilter").value;
      const sentimentFilter = document.getElementById("sentimentFilter").value;

      if (statusFilter !== "ALL") data = data.filter(item => item.status === statusFilter);
      if (sentimentFilter !== "ALL") data = data.filter(item => item.sentiment === sentimentFilter);

      const tbody = document.querySelector("#feedbackTable tbody");
      tbody.innerHTML = "";

      data.forEach(item => {
        let scoresDisplay = "-";
        if (item.sentimentScores && Object.keys(item.sentimentScores).length > 0) {
          scoresDisplay = `
            Positive: ${(item.sentimentScores.Positive * 100).toFixed(1)}%<br>
            Negative: ${(item.sentimentScores.Negative * 100).toFixed(1)}%<br>
            Neutral: ${(item.sentimentScores.Neutral * 100).toFixed(1)}%<br>
            Mixed: ${(item.sentimentScores.Mixed * 100).toFixed(1)}%
          `;
        }

        const sentimentClass = getSentimentClass(item.sentiment);

        const row = `<tr>
          <td>${item.feedback_id}</td>
          <td>${item.date}</td>
          <td>${item.customer_id}</td>
          <td>${item.comment}</td>
          <td>${item.status}</td>
          <td class="${sentimentClass}">${item.sentiment || "-"}</td>
          <td>${scoresDisplay}</td>
        </tr>`;
        tbody.innerHTML += row;
      });

      updateCharts(data);
    }

    function updateCharts(data) {
      const sentimentCounts = { POSITIVE: 0, NEGATIVE: 0, NEUTRAL: 0, MIXED: 0 };
      const statusCounts = { PENDING: 0, PROCESSED: 0 };
      const dateCounts = {};

      data.forEach(item => {
        if (item.sentiment) sentimentCounts[item.sentiment]++;
        if (item.status) statusCounts[item.status]++;
        if (item.date) {
          const d = item.date.split("T")[0];
          dateCounts[d] = (dateCounts[d] || 0) + 1;
        }
      });

      new Chart(document.getElementById("sentimentPie"), {
        type: "pie",
        data: {
          labels: ["Positive", "Negative", "Neutral", "Mixed"],
          datasets: [{
            data: [
              sentimentCounts.POSITIVE,
              sentimentCounts.NEGATIVE,
              sentimentCounts.NEUTRAL,
              sentimentCounts.MIXED
            ],
            backgroundColor: ["green", "red", "gray", "orange"]
          }]
        }
      });

      new Chart(document.getElementById("statusBar"), {
        type: "bar",
        data: {
          labels: ["Pending", "Processed"],
          datasets: [{
            label: "Count",
            data: [statusCounts.PENDING, statusCounts.PROCESSED],
            backgroundColor: ["#ffcc00", "#0073e6"]
          }]
        }
      });

      new Chart(document.getElementById("feedbackLine"), {
        type: "line",
        data: {
          labels: Object.keys(dateCounts).sort(),
          datasets: [{
            label: "Feedback Count",
            data: Object.values(dateCounts),
            borderColor: "#0073e6",
            fill: false
          }]
        }
      });
    }

    function exportCSV() {
      if (!globalData.length) {
        alert("No data to export!");
        return;
      }

      const headers = ["feedback_id", "date", "customer_id", "comment", "status", "sentiment"];
      const rows = globalData.map(item => [
        item.feedback_id,
        item.date,
        item.customer_id,
        item.comment,
        item.status,
        item.sentiment
      ]);

      let csvContent = "data:text/csv;charset=utf-8," 
        + headers.join(",") + "\n" 
        + rows.map(r => r.map(val => `"${val || ''}"`).join(",")).join("\n");

      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "feedback_export.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.getElementById("statusFilter").addEventListener("change", loadFeedback);
    document.getElementById("sentimentFilter").addEventListener("change", loadFeedback);
  </script>
</body>
</html>
